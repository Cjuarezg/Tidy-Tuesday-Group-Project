---
title: "Untitled"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(ggthemes)
library(broom)
library(ggbeeswarm)
library(tidytext)
library(ggpubr)
library(DT)
library(readr)
library(tidytext)
library(networkD3)
library(forcats)
library(plotly)

```

```{r}
#read in the data (long, one row per season)
ratings <- read_csv("../data/IMDb_Economist_tv_ratings.csv")
ratings <- ratings %>% 
  mutate(periode = cut(x = date, 
                     breaks = c(ymd("1980-01-01"), ymd("1990-01-01"),
                                ymd("2000-01-01"), ymd("2010-01-01"),
                                ymd("2019-12-31")),
                     labels=c("1980s","1990s",
                              "2000s","2010s")))

shows <- read_csv("../data/IMDb_Economist_tv_ratings.csv")

```

```{r}
#wide version of the data (one row per show)
wide_ratings <- ratings %>% pivot_wider(id_cols = c(title, genres, periode),
                        names_from = seasonNumber,
                        names_prefix = "season_",
                        names_sort = TRUE,
                        values_from = av_rating,
                        values_fill = NA) %>% 
                unnest(cols = season_1:season_44)
```

Column {data-width=500}
-----------------------------------------------------------------------

### Chart A

```{r carlos}
force_nodes_9 <- shows %>%
  select(!share) %>%
  select(!seasonNumber) %>%
  mutate(date = (ymd(date))) %>%
  mutate(start_year = year(date)) %>%
  group_by(title) %>%
  filter(start_year == min(start_year)) %>%
  select(title, genres, start_year) %>%
  mutate(decade = ifelse(start_year %in% 1990:1999, "90's", ifelse(start_year %in% 2000:2009, "00's","10's"))) %>%
  mutate(genres = gsub("-", "", genres)) %>%
  tibble() %>%
  group_by(title, decade) %>% 
  unique() %>%
  unnest_tokens(output = describers, input = genres, token = "regex", pattern = ",") %>% 
  filter(describers != "drama") %>%
  select(describers, decade) %>%
  group_by(decade) %>% 
  count(describers, sort = TRUE) %>% 
  select(describers, decade, n) %>%
  mutate(describer_deacade = paste(describers, decade, sep = "-")) %>%
  select(describer_deacade, n, decade) %>%
  as.data.frame()


force_links_7 <- shows %>%
  select(!share) %>%
  select(!seasonNumber) %>%
  mutate(date = (ymd(date))) %>%
  mutate(start_year = year(date)) %>%
  group_by(title) %>%
  filter(start_year == min(start_year)) %>%
  select(title, genres, start_year) %>%
  mutate(decade = ifelse(start_year %in% 1990:1999, "90's", ifelse(start_year %in% 2000:2009, "00's","10's"))) %>% 
  tibble() %>%
  mutate(genres = gsub("-", "", genres)) %>%
  mutate(genres = gsub("Drama", "", genres)) %>%
  mutate(genres = gsub("Drama,", "",genres)) %>%
  unnest_tokens(output = describer_bigrams, input = genres, token = "ngrams", n = 2) %>% 
  separate(describer_bigrams, c("word1", "word2"), sep = " ") %>%
  filter(!is.na(word1), 
         !is.na(word2)) %>%
  mutate(describer_deacade1 = paste(word1, decade, sep = "-"),
         describer_deacade2 = paste(word2, decade, sep = "-")) %>%
  count(describer_deacade1, describer_deacade2, sort = TRUE) %>%
  ungroup() %>%
  as.data.frame() %>%
  mutate(describer_deacade1 = factor(describer_deacade1, levels = force_nodes_9$describer_deacade)) %>%
  mutate(describer_deacade1 = as.numeric(describer_deacade1) - 1) %>%
   mutate(describer_deacade2 = factor(describer_deacade2, levels = force_nodes_9$describer_deacade)) %>%
  mutate(describer_deacade2 = as.numeric(describer_deacade2) - 1)

forcenet_4 <- forceNetwork(Links = force_links_7, Nodes = force_nodes_9, 
                           Source = "describer_deacade1", Target = "describer_deacade2", 
                           Value = "n", NodeID = "describer_deacade",  zoom = TRUE, 
                           Nodesize = "n", Group = "decade", opacityNoHover = 1, 
                           opacity = .6, legend = TRUE, fontSize = 10, charge = -15)

forcenet_4
```


### Chart B

```{r maelle}
rating_genre <- ratings %>% 
  group_by(title) %>% 
  nest() %>% 
  mutate(overall_rating= 
           map(data, 
               ~ (sum(.x$av_rating)/nrow(.x)))) %>% 
   ungroup() %>%
  unnest(cols = c(data, overall_rating)) %>% 
  separate(genres,into=c("genre1","genre2","genre3")
           ,sep = ",") %>% 
  pivot_longer(cols = c("genre1","genre2","genre3"),
               values_to = "genre") %>% 
  filter(!is.na(genre), seasonNumber==1) %>% 
  mutate(periode = cut(x = date, 
                     breaks = c( ymd("1980-01-01"),ymd("1990-01-01"),
                                ymd("2000-01-01"),ymd("2010-01-01"),
                                ymd("2019-12-31")),
                     labels=c("80's","90's",
                              "2000-2009","2010-2018")))

top_three <- rating_genre %>% 
  arrange(desc(overall_rating)) %>% 
  group_by(genre, periode) %>% 
  slice(c(1,n()))

plot <- ggplot(data = rating_genre)+
  geom_violin(aes(y = overall_rating, x=fct_infreq(genre), color=genre), size=0.5)+
  #geom_boxplot(aes(y = overall_rating, x=fct_infreq(genre), color=genre), size=0.3)+
  geom_point(data=top_three, aes(x=genre, y=overall_rating, 
                                 color= genre, fill=genre), size=0.5)+
  facet_wrap(~periode, ncol = 3)+
  labs(x = "genres", 
        y = "average rating across all seasons", 
       color= "")+
  theme_few()+
  theme(legend.position = "none")+
  coord_flip()
  
  ggplotly(plot)
  
  
  
  
  

 
  
  
  
  

```



Column {data-width=500}
-----------------------------------------------------------------------
### About Show Ratings
Add information about the data (including the data source) as well as what the dashboard can be used to explore and how to navigate it

The data table includes every show that had the highest 10 ratings by year between 1990 and 2018. One can search a year to see the top 10 shows of that year or search a show to see what year that show appeared in the top 10 as well.  


### Chart C

```{r megan}
#Table of top 10 shows by year
top_shows <- ratings %>%
  select(title, date, av_rating, genres) %>%
  mutate(date = ymd(date),
         year = year(date)) 
  
top_10 <- top_shows %>%
  group_by(year) %>%
  select(year, title, av_rating, genres) %>%
  slice_max(av_rating,n = 10) 

datatable(top_10, colnames = c("Year", "Show Name", "Rating", "Genres")) %>% formatStyle("av_rating",
  background = styleColorBar(top_10$av_rating, 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center')



  

```


### Chart D

```{r casey}
renew <- ratings %>%
  group_by(title) %>%
  mutate(overall_rat = mean(av_rating),
         renewed = max(seasonNumber > 1)) %>% 
  filter(seasonNumber == 1) %>% 
  summarize(title = title,
            renewed = as.logical(renewed),
            season1rat = av_rating,
            periode = periode)

nested_renew <- renew %>% group_by(periode) %>% nest()

renewed_stats <- nested_renew %>% 
  mutate(t_test = purrr::map(data, ~t.test(.x$season1rat ~ .x$renewed), data=.x)) %>% 
  mutate(summary = purrr::map(t_test, broom::glance)) %>% 
  unnest(cols=c(summary)) %>%
  ungroup() %>% 
  dplyr::select(periode, p.value) %>% 
  mutate(p.value = signif(p.value, digits=3),
         group1=FALSE,
         group2=TRUE) %>% 
  mutate(p.value = if_else(p.value < 5e-2, true=as.character(p.value), false="n.s."))

renew %>% 
  ggplot(aes(x=renewed, y=season1rat)) +
  stat_summary(fun = 'mean', geom="bar", fill="grey70") +
  geom_point(alpha=0.25) +
  facet_wrap(~periode) + 
  labs(x="Show Renewed",
       y = "Season 1 Rating") +
  theme(legend.position = "none") +
  stat_pvalue_manual(renewed_stats, label = "p.value", tip.length = 0.01, y.position=10.5) +
  theme_few() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))

# will try to have the info in this table
# (# shows Renewed or Not by decade)
# pop up when you scroll over each bar

#renew %>% group_by(periode, renewed) %>% summarise(n=n())
```